# Homework 2-1

### Operations on Apache Cassandra
-----
- **NOTE: python version has to be 2.7.10**

- Install and start Cassandra on docker-machine by
  ```
  docker run -d -p 7199:7199 -p 9042:9042 -p 9160:9160 -p 7001:7001 --name cassandra cassandra:3.7
  ```
  shows
  ```
  Unable to find image 'cassandra:3.7' locally
3.7: Pulling from library/cassandra
6a5a5368e0c2: Pull complete
97e4c6575710: Pull complete
d8288e3be5a2: Pull complete
d111f542073e: Pull complete
2549cfb76ce6: Pull complete
a375ee20c601: Pull complete
2e678e60bfc4: Pull complete
c2d5e7ed7dfc: Pull complete
21015df69ccb: Pull complete
a5b3a5d43f72: Pull complete
Digest: sha256:bce66127d99ff99020f2c5370b585744c851df7a21b42e7843195a0b143b94e7
Status: Downloaded newer image for cassandra:3.7
e95eb47800c41c5432742969d49316072799daee8ecdd74eca5c7e67c2ab0273
  ```

- List all running containers in docker-machine by
  ```
  docker ps
  ```
  shows
  ```
  CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                                                                                                      NAMES
e95eb47800c4        cassandra:3.7         "/docker-entrypoint.s"   2 minutes ago       Up 2 minutes        0.0.0.0:7001->7001/tcp, 0.0.0.0:7199->7199/tcp, 0.0.0.0:9042->9042/tcp, 7000/tcp, 0.0.0.0:9160->9160/tcp   cassandra
524db896b63c        confluent/kafka       "/usr/local/bin/kafka"   8 days ago          Up 4 hours          0.0.0.0:9092->9092/tcp                                                                                     kafka
a66bee8c4bd1        confluent/zookeeper   "/usr/local/bin/zk-do"   8 days ago          Up 29 hours         0.0.0.0:2181->2181/tcp, 0.0.0.0:2888->2888/tcp, 0.0.0.0:3888->3888/tcp                                     zookeeper
  ```

- Create Keyspace by
  ```
  ./cqlsh `docker-machine ip bigdata` 9042
  ```
  shows
  ```
  Connected to Test Cluster at 192.168.99.100:9042.
[cqlsh 5.0.1 | Cassandra 3.7 | CQL spec 3.4.2 | Native protocol v4]
Use HELP for help.
cqlsh>
  ```
  execute
  ```
  CREATE KEYSPACE "stock" WITH replication = {'class': 'SimpleStrategy', 'replication_factor': 1} AND durable_writes = 'true';
  ```
  ```
  USE stock;
  ```
  shows
  ```
  cqlsh:stock>
  ```
  execute
  ```
  DESCRIBE KEYSPACE;
  ```
  shows
  ```
  CREATE KEYSPACE stock WITH replication = {'class': 'SimpleStrategy', 'replication_factor': '1'}  AND durable_writes = true;
  ```

- Create table by
  ```
  CREATE TABLE user (first_name text, last_name text, PRIMARY KEY(first_name));
  ```
  then describe table by
  ```
  DESCRIBE TABLE user;
  ```
  shows
  ```
  CREATE TABLE stock.user (
    first_name text PRIMARY KEY,
    last_name text
) WITH bloom_filter_fp_chance = 0.01
    AND caching = {'keys': 'ALL', 'rows_per_partition': 'NONE'}
    AND comment = ''
    AND compaction = {'class': 'org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy', 'max_threshold': '32', 'min_threshold': '4'}
    AND compression = {'chunk_length_in_kb': '64', 'class': 'org.apache.cassandra.io.compress.LZ4Compressor'}
    AND crc_check_chance = 1.0
    AND dclocal_read_repair_chance = 0.1
    AND default_time_to_live = 0
    AND gc_grace_seconds = 864000
    AND max_index_interval = 2048
    AND memtable_flush_period_in_ms = 0
    AND min_index_interval = 128
    AND read_repair_chance = 0.0
    AND speculative_retry = '99PERCENTILE';
  ```

- Insert data by
  ```
  INSERT INTO user (first_name, last_name) VALUES ('yang', 'zhang');
  ```

- Query data by
  ```
  SELECT COUNT(*) FROM user;
  ```
  shows
  ```
   count
-------
     1

(1 rows)

Warnings :
Aggregation query used without partition key
  ```
  execute
  ```
  SELECT * FROM user WHERE first_name='yang';
  ```
  shows
  ```
  first_name | last_name
------------+-----------
       yang |     zhang
  ```
  execute
  ```
  SELECT * FROM user WHERE last_name='zhang';
  ```
  shows
  ```
  InvalidRequest: code=2200 [Invalid query] message="Cannot execute this query as it might involve data filtering and thus may have unpredictable performance. If you want to execute this query despite the performance unpredictability, use ALLOW FILTERING"
  ```
  then execute
  ```
  SELECT * FROM user WHERE last_name='zhang' ALLOW FILTERING ;
  ```
  shows
  ```
  first_name | last_name
------------+-----------
       yang |     zhang
  ```
  
- Delete data by
  ```
  DELETE last_name FROM user WHERE first_name = 'yang';
  SELECT * FROM user WHERE first_name = 'yang';
  ```
  shows
  ```
  
 first_name | last_name
------------+-----------
       yang |      null
  ```
  execute
  ```
  TRUNCATE user ;
  SELECT * FROM user WHERE first_name = 'yang';
  ```
  shows
  ```
  first_name | last_name
------------+-----------
  ```

- Drop table by
  ```
  DROP TABLE user ;
  DESCRIBE user;
  ```
  shows
  ```
  'user' not found in keyspace 'stock'
  ```
  execute
  ```
  DESCRIBE stock;
  ```
  shows
  ```
  CREATE KEYSPACE stock WITH replication = {'class': 'SimpleStrategy', 'replication_factor': '1'}  AND durable_writes = true;
  ```
  execute
  ```
  DESCRIBE TABLES;
  ```
  shows
  ```
  <empty>
  ```
  
